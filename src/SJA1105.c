#include <stdbool.h>
#include <string.h>
#include "drivers/spi.h"

#define STATIC_CONFIG_ADDR 0x20000U

// [1 bit WRITE][6 bits READ LEN][20 bits ADDRESS][4 bits DUMMY]
#define WRITE(addr) \
  0x80 | (((addr) >> 20U) & 1), (addr) >> 12U, ((addr) >> 4) & 0xFFU, ((addr) << 4) & 0xFFU

uint8_t config[] = {
    WRITE(STATIC_CONFIG_ADDR),
    // BEGIN SWITCH CONFIG
    0x9e, 0x00, 0x03, 0x0e,
    // BLOCK 0x6 HEADER
    0x06, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x5a,
    0x4e, 0xd2, 0xc5, 0x0f,
    // BLOCK 0x6 PAYLOAD
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // L2PolicyRecord(SMAX=-1, RATE=-1, MAXLEN=1518)
    0xfe, 0xf7, 0x00, 0x00,
    0x03, 0xff, 0xff, 0xff,
    // BLOCK 0x6 CRC
    0xf0, 0x5a, 0xd9, 0x4e,

    // BLOCK 0x8 HEADER
    0x08, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x1a,
    0x6a, 0xf6, 0x23, 0x53,
    // BLOCK 0x8 PAYLOAD
    // L2ForwardingRecord(BC_DOMAIN=30, REACH_PORT=30, FL_DOMAIN=30)
    0x00, 0x00, 0x00, 0x00,
    0xf7, 0xbc, 0x00, 0x00,
    // L2ForwardingRecord(BC_DOMAIN=29, REACH_PORT=29, FL_DOMAIN=29)
    0x00, 0x00, 0x00, 0x00,
    0xef, 0x7a, 0x00, 0x00,
    // L2ForwardingRecord(BC_DOMAIN=27, REACH_PORT=27, FL_DOMAIN=27)
    0x00, 0x00, 0x00, 0x00,
    0xde, 0xf6, 0x00, 0x00,
    // L2ForwardingRecord(BC_DOMAIN=23, REACH_PORT=23, FL_DOMAIN=23)
    0x00, 0x00, 0x00, 0x00,
    0xbd, 0xee, 0x00, 0x00,
    // L2ForwardingRecord(BC_DOMAIN=15, REACH_PORT=15, FL_DOMAIN=15)
    0x00, 0x00, 0x00, 0x00,
    0x7b, 0xde, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // L2ForwardingRecord()
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // BLOCK 0x8 CRC
    0xed, 0x1c, 0x07, 0x02,

    // BLOCK 0x9 HEADER
    0x09, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x23,
    0xda, 0xb5, 0xbd, 0xc8,
    // BLOCK 0x9 PAYLOAD
    // MACConfigTable(TP_DELIN=1022, TP_DELOUT=130, X=14)
    0x00, 0x00, 0x00, 0x0e,
    0x00, 0x00, 0x00, 0x00,
    0x07, 0xfc, 0x01, 0x04,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // MACConfigTable(TP_DELIN=1022, TP_DELOUT=130, X=14)
    0x00, 0x00, 0x00, 0x0e,
    0x00, 0x00, 0x00, 0x00,
    0x07, 0xfc, 0x01, 0x04,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // MACConfigTable(TP_DELIN=1022, TP_DELOUT=130, X=14)
    0x00, 0x00, 0x00, 0x0e,
    0x00, 0x00, 0x00, 0x00,
    0x07, 0xfc, 0x01, 0x04,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // MACConfigTable(TP_DELIN=1022, TP_DELOUT=130, X=14)
    0x00, 0x00, 0x00, 0x0e,
    0x00, 0x00, 0x00, 0x00,
    0x07, 0xfc, 0x01, 0x04,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // MACConfigTable(TP_DELIN=1022, TP_DELOUT=129, X=14)
    0x00, 0x00, 0x00, 0x0e,
    0x00, 0x00, 0x00, 0x00,
    0x07, 0xfc, 0x01, 0x02,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // BLOCK 0x9 CRC
    0xb2, 0x41, 0xdf, 0x1f,

    // BLOCK 0xe HEADER
    0x0e, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03,
    0xc8, 0xa7, 0xce, 0xe6,
    // BLOCK 0xe PAYLOAD
    // L2ForwardingParam(PART_SPC0=929)
    0x00, 0x74, 0x20, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // BLOCK 0xe CRC
    0x02, 0xeb, 0x6c, 0x5a,

    // BLOCK 0x11 HEADER
    0x11, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x0a,
    0x57, 0x1f, 0x81, 0x3f,
    // BLOCK 0x11 PAYLOAD
    // GeneralParameters(MAC_FLT1=-1, MAC_FLT0=-1, CASC_PORT=-1, HOST_PORT=-1, MIRR_PORT=-1, TPID=34984, TPID2=33024)
    0x00, 0x00, 0x00, 0x00,
    0x42, 0x04, 0x00, 0x00,
    0x00, 0x00, 0x04, 0x45,
    0x00, 0x00, 0x00, 0x00,
    0xff, 0x0f, 0xf8, 0x00,
    0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff,
    0x00, 0xff, 0xff, 0xff,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // BLOCK 0x11 CRC
    0xa0, 0xee, 0x2a, 0x0c,

    // BLOCK 0x4e HEADER
    0x4e, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01,
    0x3a, 0x5d, 0x5e, 0x24,
    // BLOCK 0x4e PAYLOAD
    // XMIIModeParams(xMII_MAC0=1, xMII_MAC1=1, xMII_MAC2=1, xMII_MODE3=1, xMII_MODE4=2)
    0x46, 0x48, 0x00, 0x00,
    // BLOCK 0x4e CRC
    0x86, 0x5b, 0xfe, 0xb4,

    // TOTAL CRC
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0xfc, 0x27, 0x42, 0x56,
    // END SWITCH CONFIG
};

static void SJA1105_write(uint32_t addr, uint32_t value) {
  uint8_t tx[] = {
      WRITE(addr),
      value >> 24,
      value >> 16,
      value >> 8,
      value,
  };

  spi_transfer(tx, sizeof(tx));
}

void SJA1105_init() {
  spi_init();
  SJA1105_write(0x100032, 0xB000800);
  spi_transfer(config, sizeof(config));
}
